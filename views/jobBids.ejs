<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>JobBids</title>
  <title>UserEditForm</title>
  <!-- Google Web Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Home css -->
  <link href="/home/css/style.css" rel="stylesheet">
  <link href="/my-css/style.css" rel="stylesheet">
  <link href="/client-dashboard-css/style.css" rel="stylesheet">


</head>

<body>
  <%-include("./layouts/clientDashboardNavber") %>
    <%-include("./layouts/flash") %>

      <div class="container mt-4">
        <div class="row">
          <div class="col-md-8">
            <div class="card">
              <div class="card-header">
                <h3><i class="fas fa-briefcase me-2"></i>
                  <%= job.title %>
                </h3>
                <p class="text-muted mb-0">
                  <%= job.description %>
                </p>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6">
                    <p><strong>Budget:</strong> $<%= job.budget.min %> - $<%= job.budget.max %>
                    </p>
                    <p><strong>Skills:</strong>
                      <%= job.skills.join(', ') %></p>
              </div>
              <div class="col-md-6">
                <p><strong>Deadline:</strong> <%= job.deadline.toDateString() %></p>
                <p><strong>Experience Level:</strong> <%= job.experienceLevel %></p>
              </div>
            </div>
            <% if (job.isUrgent) { %>
              <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>This is an urgent job!
              </div>
            <% } %>
          </div>
        </div>

        <h4 class="mt-4 mb-3">Bids Received (<%= bids.length %>)</h4>
        
        <% if (bids.length === 0) { %>
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>No bids received yet for this job.
          </div>
        <% } else { %>
          <% bids.forEach((bid, index) => { %>
            <div class="card mb-3 <%= bid.status === ' accepted' ? 'border-success' : '' %>">
                        <div class="card-header d-flex justify-content-between align-items-center">
                          <div>
                            <h6 class="mb-0">
                              <i class="fas fa-user me-2"></i>
                              <%= bid.freelancer.name %>
                            </h6>
                            <small class="text-muted">
                              <%= bid.freelancer.email %>
                            </small>
                          </div>
                          <div class="text-end">
                            <span
                              class="badge bg-<%= bid.status === 'pending' ? 'warning' : bid.status === 'accepted' ? 'success' : 'secondary' %>">
                              <%= bid.status.charAt(0).toUpperCase() + bid.status.slice(1) %>
                            </span>
                            <div class="mt-1">
                              <strong class="text-primary">$<%= bid.bidAmount %></strong>
                            </div>
                          </div>
                        </div>
                        <div class="card-body">
                          <h6>Proposal:</h6>
                          <p class="mb-3">
                            <%= bid.proposal %>
                          </p>

                          <div class="row">
                            <div class="col-md-6">
                              <p><strong>Estimated Delivery:</strong>
                                <%= bid.estimatedDelivery.toDateString() %>
                              </p>
                            </div>
                            <div class="col-md-6">
                              <p><strong>Bid Submitted:</strong>
                                <%= bid.createdAt.toDateString() %>
                              </p>
                              <% if (bid.status==='accepted' ) { %>
                                <p><strong>Accepted On:</strong>
                                  <%= bid.acceptedAt.toDateString() %>
                                </p>
                                <% } %>
                            </div>
                          </div>

                          <% if (bid.status==='pending' ) { %>
                            <div class="mt-3">
                              <button type="button" class="btn btn-success btn-sm me-2"
                                onclick="showAcceptModal('<%= bid._id %>', '<%= bid.freelancer.name %>')">
                                <i class="fas fa-check me-1"></i>Accept Bid
                              </button>
                              <button class="btn btn-outline-danger btn-sm"
                                onclick="showRejectModal('<%= bid._id %>', '<%= bid.freelancer.name %>')">
                                <i class="fas fa-times me-1"></i>Reject
                              </button>
                            </div>
                            <% } %>
                        </div>
                  </div>
                  <% }) %>
                    <% } %>
                </div>

                <div class="col-md-4">
                  <div class="card">
                    <div class="card-header">
                      <h5><i class="fas fa-chart-bar me-2"></i>Bid Summary</h5>
                    </div>
                    <div class="card-body">
                      <div class="d-flex justify-content-between mb-2">
                        <span>Total Bids:</span>
                        <strong>
                          <%= bids.length %>
                        </strong>
                      </div>
                      <div class="d-flex justify-content-between mb-2">
                        <span>Lowest Bid:</span>
                        <strong class="text-success">
                          $<%= bids.length> 0 ? Math.min(...bids.map(b => b.bidAmount)) : 'N/A' %>
                        </strong>
                      </div>
                      <div class="d-flex justify-content-between mb-2">
                        <span>Highest Bid:</span>
                        <strong class="text-danger">
                          $<%= bids.length> 0 ? Math.max(...bids.map(b => b.bidAmount)) : 'N/A' %>
                        </strong>
                      </div>
                      <div class="d-flex justify-content-between mb-2">
                        <span>Average Bid:</span>
                        <strong class="text-primary">
                          $<%= bids.length> 0 ? Math.round(bids.reduce((sum, b) => sum + b.bidAmount, 0) / bids.length)
                            : 'N/A' %>
                        </strong>
                      </div>
                      <hr>
                      <div class="d-flex justify-content-between">
                        <span>Job Budget:</span>
                        <strong>$<%= job.budget.min %> - $<%= job.budget.max %></strong>
                      </div>
                    </div>
                  </div>

                  <div class="card">
                    <div class="card-header">
                      <h5><i class="fas fa-user me-2"></i>Freelancer Profiles</h5>
                    </div>
                    <div class="card-body">
                      <% if (bids && bids.length> 0) { %>
                        <% bids.forEach(bid=> { %>
                          <div class="d-flex justify-content-between mb-2">
                            <span>Name:</span>
                            <strong>
                              <%= bid.freelancer.name %>
                            </strong>
                          </div>
                          <div class="d-flex justify-content-between mb-2">
                            <span>Phone:</span>
                            <strong>
                              <%= bid.freelancer.phone %>
                            </strong>
                          </div>
                          <div class="d-flex justify-content-between mb-2">
                            <span>Experience:</span>
                            <strong>
                              <%= bid.freelancer.experienceLevel %>
                            </strong>
                          </div>
                          <div class="d-flex justify-content-between mb-2">
                            <span>Rate:</span>
                            <strong>
                              <%= bid.freelancer.hourlyRate %> $/hr
                            </strong>
                          </div>
                          <div class="d-flex justify-content-between mb-2">
                            Skills:-<span>
                             <%= bid.freelancer.skills.slice(0, 5).join(', ') %>
                          <% if (bid.freelancer.skills.length > 5) { %>
                             <h6> +<%= bid.freelancer.skills.length - 5 %> more </h6>
                            </span>
                          <% } %>
                          </div>
                          <div class="d-flex justify-content-between mb-2">
                            <% if (bid.freelancer.bio) { %>
                          <% const bio = bid.freelancer.bio; %>
                          Bio:-<span><%= bio.length > 120 ? bio.slice(0, 100) + '…' : bio %></span>
                      <% } %>
                          </div>
                          <% }) %>
                            <% } else { %>
                              <p>No bids yet.</p>
                          <% } %>
                    </div>
                  </div>


                  <div class="card mt-3">
                    <div class="card-header">
                      <h5><i class="fas fa-lightbulb me-2"></i>Tips</h5>
                    </div>
                    <div class="card-body">
                      <ul class="list-unstyled mb-0">
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Review all proposals carefully
                        </li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Consider delivery timeline</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Check freelancer's communication
                        </li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Balance cost vs. quality</li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Accept Modal -->
            <div class="modal fade" id="acceptModal" tabindex="-1">
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">Accept Bid</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body">
                    <p>Are you sure you want to accept <strong id="acceptFreelancerName"></strong>'s bid?</p>
                    <p class="text-muted">This will close the job to other bids and start the project.</p>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <form id="acceptBidForm" method="POST" style="display: inline;">
                      <button type="submit" class="btn btn-success">Accept Bid</button>
                    </form>
                  </div>
                </div>
              </div>
            </div>

            <!-- Reject Modal -->
            <div class="modal fade" id="rejectModal" tabindex="-1">
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">Reject Bid</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body">
                    <p>Are you sure you want to reject <strong id="freelancerName"></strong>'s bid?</p>
                    <p class="text-muted">This action cannot be undone.</p>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="rejectBid()">Reject Bid</button>
                  </div>
                </div>
              </div>
            </div>

            <footer>
              <%-include("./layouts/footer") %>
            </footer>

            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
            <script>
              let currentBidId = null;

              function showAcceptModal(bidId, freelancerName) {
                document.getElementById('acceptFreelancerName').textContent = freelancerName;
                document.getElementById('acceptBidForm').action = `/bids/${bidId}/accept`;
                new bootstrap.Modal(document.getElementById('acceptModal')).show();
              }

              function showRejectModal(bidId, freelancerName) {
                currentBidId = bidId;
                document.getElementById('freelancerName').textContent = freelancerName;
                new bootstrap.Modal(document.getElementById('rejectModal')).show();
              }

              function rejectBid() {
                if (currentBidId) {
                  // Create a form to submit the reject request
                  const form = document.createElement('form');
                  form.method = 'POST';
                  form.action = `/bids/${currentBidId}/reject`;

                  // Submit the form
                  document.body.appendChild(form);
                  form.submit();
                }
              }
            </script>

            <!-- JavaScript Libraries -->
            <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
            <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>
            <script src="home/lib/easing/easing.min.js"></script>
            <script src="home/lib/owlcarousel/owl.carousel.min.js"></script>
            <script src="home/lib/tempusdominus/js/moment.min.js"></script>
            <script src="home/lib/tempusdominus/js/moment-timezone.min.js"></script>
            <script src="home/lib/tempusdominus/js/tempusdominus-bootstrap-4.min.js"></script>

            <!-- Contact Javascript File -->
            <script src="home/mail/jqBootstrapValidation.min.js"></script>
            <script src="home/mail/contact.js"></script>

            <!-- Template Javascript -->
            <script src="home/js/main.js"></script>
</body>

</html>